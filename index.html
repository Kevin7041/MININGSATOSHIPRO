<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Satoshi Overdrive Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --bg-dark: #05000a;
            --card-bg: #130026;
            --primary: #8b5cf6;
            --ton-blue: #0098EA;
        }
        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; overflow: hidden; -webkit-tap-highlight-color: transparent;
        }
        .main-container {
            height: 100vh; overflow-y: auto; padding: 20px 20px 120px 20px; box-sizing: border-box;
            background-image: linear-gradient(rgba(139,92,246,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(139,92,246,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }

        /* Tarjetas y Botones */
        .card {
            background-color: rgba(19, 0, 38, 0.8); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.05); border-radius: 2rem; padding: 20px; margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(to right, #7c3aed, #c026d3); border: none; color: white;
            padding: 16px; border-radius: 16px; font-weight: 900; text-transform: uppercase;
            width: 100%; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }
        .btn:active { transform: scale(0.95); }
        .btn-ton {
            background: #0098EA;
            box-shadow: 0 0 15px rgba(0, 152, 234, 0.4);
        }

        /* Clicker */
        .clicker-container {
            position: relative; width: 260px; height: 260px; margin: 20px auto; display: flex; justify-content: center; align-items: center;
        }
        .clicker-btn {
            width: 200px; height: 200px; border-radius: 50%;
            background: radial-gradient(circle at center, #4c1d95, #0a0014);
            border: 2px solid rgba(139,92,246,0.5); box-shadow: 0 0 50px rgba(139,92,246,0.3);
            display: flex; justify-content: center; align-items: center; font-size: 60px; cursor: pointer; z-index: 10;
        }
        .clicker-btn:active { transform: scale(0.95); }

        /* Tienda */
        .shop-item {
            background: #130026; padding: 15px; border-radius: 15px; margin-bottom: 10px;
            border: 1px solid rgba(139,92,246,0.1); display: flex; justify-content: space-between; align-items: center;
        }

        /* Navegaci√≥n */
        .nav-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px; background: rgba(15, 5, 24, 0.95); backdrop-filter: blur(20px);
            border: 1px solid rgba(139,92,246,0.2); border-radius: 40px; display: flex; justify-content: space-around; padding: 10px; z-index: 100;
        }
        .nav-item { background: none; border: none; color: #64748b; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #e879f9; }
        
        /* Contenedor del Bot√≥n TON Connect */
        #ton-connect-btn { width: 100%; display: flex; justify-content: center; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div id="view-home">
            <div class="text-center" style="margin-top: 10px;">
                <h2 style="font-style: italic; font-weight: 900; margin: 0;">SATOSHI <span style="color: #facc15;">OD</span></h2>
                <div style="font-size: 12px; color: #a78bfa; margin-top: 5px;">POTENCIA: <span id="total-rate">0</span> SATS/s</div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="flex" style="justify-content: space-between; font-size: 10px; font-weight: 900; color: #cbd5e1; text-transform: uppercase;">
                    <span>Almacenamiento</span>
                    <span id="storage-text">0 / 1000</span>
                </div>
                <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.4); border-radius: 10px; margin: 10px 0;">
                    <div id="storage-bar" style="width: 0%; height: 100%; background: linear-gradient(to right, #06b6d4, #8b5cf6); border-radius: 10px;"></div>
                </div>
                <button onclick="claimAuto()" class="btn" style="padding: 10px; font-size: 12px; margin-top: 5px;">RECLAMAR</button>
            </div>

            <div class="text-center">
                <div style="font-size: 3.5rem; font-weight: 900; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.3);" id="score">0</div>
                <div style="font-size: 10px; font-weight: 900; color: #64748b; letter-spacing: 2px;">BALANCE TOTAL</div>
            </div>

            <div class="clicker-container">
                <div class="clicker-btn" id="coin-btn">‚Çø</div>
            </div>
            <div class="text-center" style="font-size: 12px; color: #facc15;">‚ö° <span id="energy">1000</span></div>
        </div>

        <div id="view-mine" class="hidden">
            <h2 class="text-center" style="font-style: italic;">HARDWARE</h2>
            
            <div style="margin-bottom: 20px;">
                <div style="font-size: 10px; color: #0098EA; font-weight: 900; margin-bottom: 10px; letter-spacing: 1px;">MAQUINAS TON (PREMIUM)</div>
                <div id="ton-machines-list"></div>
            </div>

            <div>
                <div style="font-size: 10px; color: #a78bfa; font-weight: 900; margin-bottom: 10px; letter-spacing: 1px;">MEJORAS B√ÅSICAS (SATS)</div>
                <div id="basic-machines-list"></div>
            </div>
        </div>

        <div id="view-wallet" class="hidden">
            <div class="card" style="background: linear-gradient(135deg, #1e1b4b, #130026);">
                <span style="font-size: 10px; color: rgba(255,255,255,0.5);">MI BILLETERA</span>
                <h1 style="margin: 10px 0;" id="wallet-balance">0</h1>
                <div style="font-size: 20px; color: #34d399; font-weight: bold; margin-top: 10px;" id="usdt-value">‚âà $0.00</div>
                
                <div id="ton-connect-btn"></div>
                <p id="wallet-status" style="font-size: 10px; text-align: center; margin-top: 10px; color: #64748b;">Conecta tu wallet para comprar m√°quinas Premium</p>
            </div>
            <button class="btn" onclick="saveGame(true)">üíæ GUARDAR MANUALMENTE</button>
        </div>
    </div>

    <div class="nav-dock">
        <button class="nav-item active" onclick="switchTab('home', this)"><i data-lucide="home" width="20"></i><span>BASE</span></button>
        <button class="nav-item" onclick="switchTab('mine', this)"><i data-lucide="zap" width="20"></i><span>MINAR</span></button>
        <button class="nav-item" onclick="switchTab('wallet', this)"><i data-lucide="wallet" width="20"></i><span>WALLET</span></button>
    </div>

    <script>
        // --- CONFIGURACI√ìN CR√çTICA ---
        // 1. TU DIRECCI√ìN DE BILLETERA (Donde recibir√°s los pagos)
        const ADMIN_WALLET = "UQAhKfWAyGxvnqR1J7ZUaJWs5xTJVJ2uTAMxB_vH-sL4zMt1";
        
        // 2. URL DEL MANIFEST (Debes crear el archivo tonconnect-manifest.json en tu GitHub)
        // Aseg√∫rate de que esta URL sea correcta seg√∫n tu usuario y repo de GitHub
        const MANIFEST_URL = "https://kevin7041.github.io/miniapp/tonconnect-manifest.json";

        // --- INICIALIZACI√ìN ---
        lucide.createIcons();
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Inicializar TON Connect UI
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: MANIFEST_URL,
            buttonRootId: 'ton-connect-btn'
        });

        // --- DATOS DEL JUEGO ---
        let gameState = {
            score: 0,
            energy: 1000,
            miningRate: 0,
            autoBalance: 0,
            machinesOwned: [] // Para rastrear qu√© compraron
        };
        const MAX_STORAGE = 1000;

        // --- M√ÅQUINAS ---
        const tonMachines = [
            { id: 1, name: "Starter Rig", cost: 1, power: 100, desc: "Aceleraci√≥n x10" },
            { id: 2, name: "Turbo Miner", cost: 5, power: 600, desc: "Aceleraci√≥n x60" },
            { id: 3, name: "Quantum Core", cost: 10, power: 1500, desc: "Potencia Industrial" },
            { id: 4, name: "GOD MODE", cost: 30, power: 5000, desc: "M√ÅXIMA POTENCIA" }
        ];

        const basicMachines = [
            { id: 101, name: "CPU B√°sico", cost: 500, power: 1 },
            { id: 102, name: "GPU Usada", cost: 2000, power: 5 }
        ];

        // --- SISTEMA DE GUARDADO (PERSISTENCIA) ---
        function loadGame() {
            const saved = localStorage.getItem('satoshi_save_v1');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameState = { ...gameState, ...parsed };
                    // Calcular fecha para offline earnings (opcional, b√°sico por ahora)
                } catch (e) { console.error("Error cargando partida", e); }
            }
            updateUI();
        }

        function saveGame(showMsg = false) {
            localStorage.setItem('satoshi_save_v1', JSON.stringify(gameState));
            if(showMsg) tg.showAlert("‚úÖ Progreso guardado correctamente.");
        }

        // Guardado autom√°tico cada 5 segundos
        setInterval(() => saveGame(), 5000);

        // --- L√ìGICA DE TIENDA Y PAGOS TON ---
        async function buyWithTon(id) {
            const machine = tonMachines.find(m => m.id === id);
            
            // Verificar si la wallet est√° conectada
            if (!tonConnectUI.connected) {
                return tg.showAlert("‚ö†Ô∏è Primero conecta tu Wallet en la pesta√±a 'B√≥veda'.");
            }

            // Preparar transacci√≥n (Cantidad en Nanotons: 1 TON = 1,000,000,000)
            const amountInNano = (machine.cost * 1000000000).toString();
            
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600, // 10 min para pagar
                messages: [
                    {
                        address: ADMIN_WALLET,
                        amount: amountInNano,
                    }
                ]
            };

            try {
                // Enviar transacci√≥n a la wallet conectada
                const result = await tonConnectUI.sendTransaction(transaction);
                
                // Si llegamos aqu√≠, la transacci√≥n se envi√≥ con √©xito
                gameState.miningRate += machine.power;
                gameState.machinesOwned.push(machine.id);
                saveGame();
                
                tg.showAlert(`‚úÖ ¬°PAGO EXITOSO!\n\nHas recibido: ${machine.name}\nPotencia aumentada: +${machine.power}`);
                updateUI();
                
            } catch (e) {
                console.error(e);
                tg.showAlert("‚ùå Pago cancelado o fallido.");
            }
        }

        function buyBasic(id) {
            const m = basicMachines.find(x => x.id === id);
            if (gameState.score >= m.cost) {
                gameState.score -= m.cost;
                gameState.miningRate += m.power;
                tg.showAlert(`¬°Mejora comprada! +${m.power} SATS/s`);
                updateUI();
            } else {
                tg.showAlert("Saldo insuficiente.");
            }
        }

        // --- UI RENDER ---
        function renderShop() {
            const tonList = document.getElementById('ton-machines-list');
            const basicList = document.getElementById('basic-machines-list');

            tonList.innerHTML = tonMachines.map(m => `
                <div class="shop-item" style="border: 1px solid rgba(0, 152, 234, 0.3); background: rgba(0, 152, 234, 0.05);">
                    <div>
                        <div style="font-weight:900; font-size:14px;">${m.name}</div>
                        <div style="font-size:10px; color:#0098EA;">+${m.power} SATS/s</div>
                        <div style="font-size:9px; color:#64748b;">${m.desc}</div>
                    </div>
                    <button class="btn btn-ton" style="width:auto; padding:8px 16px; margin:0;" onclick="buyWithTon(${m.id})">
                        üíé ${m.cost} TON
                    </button>
                </div>
            `).join('');

            basicList.innerHTML = basicMachines.map(m => `
                <div class="shop-item">
                    <div>
                        <div style="font-weight:900; font-size:14px;">${m.name}</div>
                        <div style="font-size:10px; color:#a78bfa;">+${m.power} SATS/s</div>
                    </div>
                    <button class="btn" style="width:auto; padding:8px 16px; margin:0; font-size:10px; background:#2d1245;" onclick="buyBasic(${m.id})">
                        ${m.cost} SATS
                    </button>
                </div>
            `).join('');
        }

        function updateUI() {
            document.getElementById('score').innerText = Math.floor(gameState.score).toLocaleString();
            document.getElementById('wallet-balance').innerText = Math.floor(gameState.score).toLocaleString();
            document.getElementById('usdt-value').innerText = `‚âà $${(gameState.score / 1000000).toFixed(4)}`;
            document.getElementById('energy').innerText = Math.floor(gameState.energy);
            document.getElementById('total-rate').innerText = gameState.miningRate;
            
            document.getElementById('storage-text').innerText = `${Math.floor(gameState.autoBalance)} / ${MAX_STORAGE}`;
            document.getElementById('storage-bar').style.width = `${(gameState.autoBalance/MAX_STORAGE)*100}%`;
            
            // Estado Wallet
            const statusEl = document.getElementById('wallet-status');
            if (tonConnectUI.connected) {
                statusEl.innerText = "‚úÖ Billetera Conectada";
                statusEl.style.color = "#4ade80";
            } else {
                statusEl.innerText = "Conecta tu wallet para comprar m√°quinas Premium";
                statusEl.style.color = "#64748b";
            }
        }

        // --- BUCLES ---
        setInterval(() => {
            if (gameState.miningRate > 0) gameState.score += gameState.miningRate;
            if (gameState.autoBalance < MAX_STORAGE) gameState.autoBalance += 1;
            if (gameState.energy < 1000) gameState.energy += 2;
            updateUI();
        }, 1000);

        function claimAuto() {
            if (gameState.autoBalance > 0) {
                gameState.score += gameState.autoBalance;
                gameState.autoBalance = 0;
                tg.showAlert("Recolectado.");
                updateUI();
            }
        }

        document.getElementById('coin-btn').addEventListener('click', (e) => {
            if(gameState.energy > 0) {
                gameState.score++;
                gameState.energy--;
                if(navigator.vibrate) navigator.vibrate(10);
                updateUI();
                // Efecto flotante
                const el = document.createElement('div');
                el.innerText = "+1"; el.style.position='fixed'; el.style.left=e.clientX+'px'; el.style.top=e.clientY+'px'; el.style.color='white'; el.style.fontWeight='bold'; el.style.pointerEvents='none';
                document.body.appendChild(el); setTimeout(()=>el.remove(), 500);
            }
        });

        function switchTab(tab, btn) {
            ['home', 'mine', 'wallet'].forEach(t => document.getElementById('view-'+t).classList.add('hidden'));
            document.getElementById('view-'+tab).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Arrancar
        loadGame(); // Cargar datos guardados
        renderShop();
        updateUI();

    </script>
</body>
</html>
